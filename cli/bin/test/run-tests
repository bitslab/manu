#!/bin/bash

set -euo pipefail

if [[ "${MAVEN_CMD_LINE_ARGS:-}" == *"-DskipTests"* ]]; then
  exit 0
fi


here=$(dirname "${BASH_SOURCE[0]}")
here=$(readlink -f "$here")

# shellcheck source=cli/bin/test/lib.sh
. "$here"/lib.sh

tmpdir=$(mktemp --directory run_tests.XXXX)
function finish {
  rm -rf "$tmpdir"
}
trap finish EXIT

if [ ! -v coverage ]; then
  export coverage=1
fi

function test_ensure_keys_no_args_is_error {
  run "$here"/../ensure-keys

  assert_exit_code 1
}

function test_ensure_keys_can_add_key_from_stdin {
  echo "x" | run "$here"/../ensure-keys /tmp/foo.bar

  assert_exit_code 0
}

function test_write_no_args_is_error {
  run "$here"/../write

  assert_exit_code 1
}

function test_write_no_fields_is_error {
  run "$here"/../write keys.index output.file 1970-01-01 hour

  assert_exit_code 1
}

function test_write {
  pvs_file="$tmpdir"/pvs.file
  keys_index="$tmpdir"/keys.index
  output_file="$tmpdir"/output
  cat > "$pvs_file".spaces <<EOF
a 1 2 3
b 123 123 123
c 456 456 456
EOF
  tr ' ' '\t' < "$pvs_file".spaces > "$pvs_file"

  awk -F $'\t' '{print $1}' "$pvs_file" | run "$here"/../ensure-keys "$keys_index"
  assert_exit_code 0

  run "$here"/../write "$keys_index" "$output_file" 1970-01-01 hour --fixed1 pageviews "$pvs_file"
  assert_exit_code 0
}

function test_write_two_fields {
  pvs_file="$tmpdir"/pvs.file
  keys_index="$tmpdir"/keys.index
  output_file="$tmpdir"/output
  cat > "$pvs_file".spaces <<EOF
a 1 2 3
b 123 123 123
c 456 456 456
EOF
  tr ' ' '\t' < "$pvs_file".spaces > "$pvs_file"

  awk -F $'\t' '{print $1}' "$pvs_file" | run "$here"/../ensure-keys "$keys_index"
  assert_exit_code 0

  run "$here"/../write "$keys_index" "$output_file" 1970-01-01 hour --lossy pageviews "$pvs_file" --fixed2 edits "$pvs_file"
  assert_exit_code 0
}


function run_test {
  fn="$1"
  reset_test
  rm -rf "$tmpdir"
  mkdir -p "$tmpdir"
  echo "Test: $fn"
  "$fn"
  log_if_errors
  return "$test_result"
}


rv=0
if [ $# -gt 0 ]; then
  while [ $# -gt 0 ]; do
    fn="$1"
    shift
    if ! run_test "$fn"; then
      rv=1
    fi
  done
else
  while read -r fn; do
    if ! run_test "$fn"; then
      rv=1
    fi
  done < <(find_tests)
fi

exit "$rv"
