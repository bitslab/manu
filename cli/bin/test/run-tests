#!/bin/bash

set -euo pipefail

if [[ "${MAVEN_CMD_LINE_ARGS:-}" == *"-DskipTests"* ]]; then
  exit 0
fi


here=$(dirname "${BASH_SOURCE[0]}")
here=$(readlink -f "$here")

# shellcheck source=cli/bin/test/lib.sh
. "$here"/lib.sh

log_tmp=$(mktemp --tmpdir run_tests.XXXX)
tmp_dir=$(mktemp --directory run_tests.XXXX)
function finish {
  rm -f "$log_tmp"
  rm -rf "$tmp_dir"
}
trap finish EXIT

if [ ! -v coverage ]; then
  export coverage=1
fi

function test_ensure_keys_no_args_is_error {
  run "$here"/../ensure-keys

  assert_exit_code 1
}

function test_ensure_keys_can_add_key_from_stdin {
  echo "x" | run "$here"/../ensure-keys /tmp/foo.bar

  assert_exit_code 0
}

function test_write_no_args_is_error {
  run "$here"/../write

  assert_exit_code 1
}

function test_write_no_fields_is_error {
  run "$here"/../write keys.index output.file 1970-01-01 hour

  assert_exit_code 1
}

function test_write {
  pvs_file="$tmp_dir"/pvs.file
  run "$here"/../write keys.index output.file 1970-01-01 hour pageviews "$pvs_file"

  assert_exit_code 0
}


while read -r fn; do
  reset_test
  rm -rf "$tmp_dir"
  mkdir -p "$tmp_dir"
  echo "Test: $fn"
  "$fn"
  log_if_errors
done < <(find_tests)

